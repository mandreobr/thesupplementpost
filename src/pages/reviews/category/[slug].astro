---
// Imports
import { getCollection } from "astro:content";
import { CATEGORY_CONFIG } from "../../../config/categories";

// 1) Static paths
export async function getStaticPaths() {
  const paths = Object.values(CATEGORY_CONFIG).map((config) => ({
    params: { slug: config.slug },
  }));
  return paths;
}

// 2) Load reviews
const reviews = await getCollection("reviews");

// 3) Retrieve slug + match category
const { slug } = Astro.params;

const entries = Object.entries(CATEGORY_CONFIG);
const match = entries.find(([, cfg]) => cfg.slug === slug);

if (!match) {
  throw new Error(`Category not found for slug: ${slug}`);
}

const [categoryKey, categoryConfig] = match;

// Normalize helper
const normalize = (val) =>
  val
    ? String(val)
        .trim()
        .toLowerCase()
        .replace(/[’']/g, "")
        .replace(/\s+/g, "-")
    : "";

// Filtering
const categoryReviews = reviews.filter((review) => {
  const raw = review.data.category;
  if (!raw) return false;

  const slugNorm = slug.toLowerCase();
  const valueNorm = normalize(raw);
  return valueNorm === slugNorm;
});

// Text helpers
const categoryTitle =
  categoryConfig.title ?? categoryConfig.label ?? categoryKey;

const categoryDescription =
  categoryConfig.description ??
  `Explore in-depth supplement reviews for ${categoryTitle} on The Supplement Post.`;

const canonicalUrl = `https://www.thesupplementpost.com/reviews/category/${slug}/`;

const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "All Reviews", url: "/reviews" },
  { name: categoryTitle, url: canonicalUrl },
];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <!-- VIEWPORT PARA MOBILE -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{categoryTitle} — Supplement Reviews | The Supplement Post</title>
    <meta name="description" content={categoryDescription} />
    <meta name="robots" content="index,follow" />

    <link rel="canonical" href={canonicalUrl} />

    <!-- Inter font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
    />

    <style>
      :root {
        --primary-blue: #1e3a8a;

        --bg-page: #f3f4f6; /* fundo externo */
        --bg-container: #ffffff; /* painel central */
        --bg-card: #ffffff; /* cards */

        --text-main: #1f2937;
        --text-muted: #6b7280;

        --shadow-soft: 0 8px 24px rgba(0, 0, 0, 0.06);
        --border-subtle: #e5e7eb;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg-page);
        color: var(--text-main);
        font-family: "Inter", sans-serif;
      }

      /* HEADER */
      .site-header {
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      }

      .header-inner {
        max-width: 1120px;
        margin: 0 auto;
        padding: 14px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .brand {
        font-size: 14px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--primary-blue);
      }

      .header-nav a {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-muted);
        text-decoration: none;
      }

      .header-nav a:hover {
        color: var(--primary-blue);
      }

      /* WRAPPER CENTRAL */
      .page-wrapper {
        max-width: 1120px;
        margin: 40px auto;
        background: var(--bg-container);
        padding: 40px 32px;
        border-radius: 22px;
        box-shadow: var(--shadow-soft);
      }

      /* Breadcrumb */
      .breadcrumb ol {
        padding: 0;
        margin: 0 0 18px;
        list-style: none;
        display: flex;
        gap: 6px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .breadcrumb a {
        text-decoration: none;
        color: var(--text-muted);
      }

      .breadcrumb-current {
        font-weight: 600;
        color: #374151;
      }

      /* Category Header */
      .category-hero {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid var(--border-subtle);
        padding: 28px 24px;
        margin-bottom: 40px;
      }

      .category-title {
        font-size: 32px;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0 0 10px;
      }

      .category-description {
        max-width: 680px;
        font-size: 15px;
        line-height: 1.6;
        color: var(--text-muted);
      }

      /* Article list */
      .article-list {
        display: flex;
        flex-direction: column;
        gap: 28px;
      }

      /* CARD */
      .article-card {
        display: block;
        background: var(--bg-card);
        border-radius: 18px;
        border: 1px solid var(--border-subtle);
        text-decoration: none;
        color: inherit;
        box-shadow: var(--shadow-soft);
        transition: 0.2s ease;
      }

      .article-card:hover {
        transform: translateY(-3px);
      }

      .article-card-inner {
        display: flex;
        flex-direction: column;
      }

      @media (min-width: 768px) {
        .article-card-inner {
          flex-direction: row;
          height: 240px;
        }
      }

      /* IMAGEM ESQUERDA — fundo totalmente branco */
      .article-image-container {
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 180px;
      }

      @media (min-width: 768px) {
        .article-image-container {
          width: 34%;
          height: 100%;
        }
      }

      .article-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 20px;
      }

      /* CONTENT */
      .article-content {
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      @media (min-width: 768px) {
        .article-content {
          width: 66%;
          padding: 32px;
        }
      }

      .article-title {
        font-size: 22px;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0 0 12px;
      }

      .article-description {
        margin: 0 0 14px;
        font-size: 15px;
        line-height: 1.6;
        color: #374151;
      }

      .article-cta {
        margin-top: auto;
        font-size: 14px;
        font-weight: 600;
        color: var(--primary-blue);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      /* Footer */
      .site-footer {
        margin-top: 60px;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
      }

      .footer-inner {
        max-width: 1120px;
        margin: 0 auto;
        padding: 18px;
        text-align: center;
        font-size: 12px;
        color: #6b7280;
      }

      /* =========
         AJUSTES MOBILE
         ========= */
      @media (max-width: 640px) {
        .header-inner {
          padding: 12px 12px;
        }

        .brand {
          font-size: 12px;
          letter-spacing: 0.18em;
        }

        .header-nav a {
          font-size: 14px;
        }

        .page-wrapper {
          margin: 24px 12px;
          padding: 24px 18px;
          border-radius: 18px;
        }

        .breadcrumb ol {
          font-size: 11px;
          flex-wrap: wrap;
        }

        .category-hero {
          padding: 22px 18px;
          margin-bottom: 28px;
        }

        .category-title {
          font-size: 24px;
          line-height: 1.25;
        }

        .category-description {
          font-size: 14px;
        }

        .article-image-container {
          height: 200px;
        }

        .article-content {
          padding: 20px;
        }

        .article-title {
          font-size: 18px;
        }

        .article-description {
          font-size: 14px;
        }

        .article-cta {
          font-size: 14px;
        }

        .footer-inner {
          font-size: 11px;
          padding: 16px;
        }
      }
    </style>
  </head>

  <body>
    <header class="site-header">
      <div class="header-inner">
        <div class="brand">The Supplement Post</div>
        <nav class="header-nav">
          <a href="/">Home</a>
        </nav>
      </div>
    </header>

    <main class="page-wrapper">
      <nav class="breadcrumb">
        <ol>
          {breadcrumbs.map((crumb, index) => (
            <li>
              {index > 0 && <span>/</span>}
              {index < breadcrumbs.length - 1 ? (
                <a href={crumb.url}>{crumb.name}</a>
              ) : (
                <span class="breadcrumb-current">{crumb.name}</span>
              )}
            </li>
          ))}
        </ol>
      </nav>

      <section class="category-hero">
        <h1 class="category-title">{categoryTitle}</h1>
        <p class="category-description">{categoryDescription}</p>
      </section>

      {categoryReviews.length === 0 ? (
        <section class="empty-state">
          <p>No reviews found for this category.</p>
        </section>
      ) : (
        <section class="article-list">
          {categoryReviews.map((review) => {
            const title = review.data.pageTitle ?? review.data.title;
            const description = review.data.description ?? "";
            const heroImage = review.data.heroImage ?? null;

            return (
              <a href={`/reviews/${review.slug}`} class="article-card">
                <div class="article-card-inner">
                  <div class="article-image-container">
                    {heroImage ? (
                      <img
                        src={heroImage}
                        alt={title}
                        class="article-image"
                      />
                    ) : (
                      <div>Hero Image</div>
                    )}
                  </div>

                  <div class="article-content">
                    <h2 class="article-title">{title}</h2>
                    <p class="article-description">{description}</p>

                    <div class="article-cta">
                      Read Full Review →
                    </div>
                  </div>
                </div>
              </a>
            );
          })}
        </section>
      )}
    </main>

    <footer class="site-footer">
      <div class="footer-inner">
        © The Supplement Post. All rights reserved.
      </div>
    </footer>
  </body>
</html>
