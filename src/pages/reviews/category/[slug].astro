---
import { getCollection } from "astro:content";
import { CATEGORY_CONFIG } from "../../../config/categories";
import { SITE_URL } from "../../../config/site";

/* =========================
   STATIC PATHS
========================= */
export async function getStaticPaths() {
  return Object.values(CATEGORY_CONFIG).map((config) => ({
    params: { slug: config.slug },
  }));
}

/* =========================
   LOAD CONTENT
========================= */
const reviews = await getCollection("reviews");
const { slug } = Astro.params;

if (!slug) {
  throw new Error("Category slug is missing.");
}

/* =========================
   MATCH CATEGORY CONFIG
========================= */
const entry = Object.entries(CATEGORY_CONFIG).find(([, cfg]) => cfg.slug === slug);

if (!entry) {
  throw new Error(`Category not found for slug: ${slug}`);
}

const [categoryKey, categoryConfig] = entry;

/* =========================
   HELPERS
========================= */
const normalize = (value) =>
  value
    ? String(value)
        .trim()
        .toLowerCase()
        .replace(/[’']/g, "")
        .replace(/\s+/g, "-")
    : "";

// minis "flattened" (prostadine-what-is, prostadine-price, etc)
const MINI_SUFFIXES = [
  "what-is",
  "ingredients",
  "side-effects",
  "price",
  "pros-and-cons",
  "does-really-work",
];

const isMiniSlug = (s) => {
  if (!s) return false;
  return MINI_SUFFIXES.some((suffix) => s.endsWith(`-${suffix}`) || s.endsWith(`/${suffix}`));
};

const getFolderCategorySlugFromId = (id) => {
  // id pode ser:
  // "Men-Health/prostadine/index"
  // "Men-Health/prostadine/what-is"
  // "Men-Health/prostadine-what-is"
  // pegamos a primeira parte como "Men-Health"
  const first = (id || "").split("/")[0];
  return normalize(first);
};

const isFullReview = (review) => {
  const id = review?.id || "";
  const s = review?.slug || "";

  // Formato clássico em pasta: .../index
  if (id.endsWith("/index")) return true;

  // Formato "flatten": FULL costuma ser só "prostadine" (sem sufixo de mini)
  // (e normalmente sem barra)
  const looksLikeSingle = !s.includes("/");
  if (looksLikeSingle && !isMiniSlug(s)) return true;

  // Extra segurança: se slug tem pasta e NÃO parece mini, trate como full
  // Ex: "Men-Health/prostadine"
  const parts = s.split("/").filter(Boolean);
  if (parts.length === 2 && !isMiniSlug(s)) return true;

  return false;
};

const isSameCategory = (review) => {
  // 1) Preferência: frontmatter category (quando existe e é confiável)
  const byFrontmatter = review?.data?.category === slug;

  // 2) Fallback: pasta (Men-Health -> men-health)
  const byFolder = getFolderCategorySlugFromId(review?.id) === slug;

  return byFrontmatter || byFolder;
};

const getPublicSlug = (review) => {
  // Se vier "Men-Health/prostadine" -> "prostadine"
  // Se vier "prostadine" -> "prostadine"
  // Se vier "prostadine-what-is" -> "prostadine-what-is" (mas minis já serão filtradas fora)
  const s = String(review?.slug || "");
  return s.includes("/") ? s.split("/").filter(Boolean).pop() : s;
};

const decodeHtmlEntities = (str) =>
  String(str || "")
    .replace(/&amp;/g, "&")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .trim();

const cleanTag = (tag) => {
  let t = decodeHtmlEntities(tag);
  // remove espaços e restos comuns
  t = t.replace(/\s+/g, " ").trim();
  // remove trailing punctuation estranha
  t = t.replace(/[•·|]+$/g, "").trim();
  return t;
};

/**
 * ✅ Extrai Health Condition Tags do bloco "HEALTH CONDITION TAGS"
 * Regra: pega tudo entre "HEALTH CONDITION TAGS" e "INGREDIENT TAGS" (ou fim)
 * Suporta:
 *  - <span>Tag</span>
 *  - <a>Tag</a>
 *  - listas markdown: "- Tag"
 *  - fallback por linhas
 */
const extractHealthTagsFromBody = (body, limit = 8) => {
  const raw = String(body || "");
  const startIdx = raw.toUpperCase().indexOf("HEALTH CONDITION TAGS");
  if (startIdx === -1) return [];

  const afterStart = raw.slice(startIdx);
  const endIdxLocal = afterStart.toUpperCase().indexOf("INGREDIENT TAGS");
  const block = endIdxLocal !== -1 ? afterStart.slice(0, endIdxLocal) : afterStart;

  const collected = [];

  // 1) <span ...>TAG</span>
  const spanRe = /<span\b[^>]*>([^<]{1,120})<\/span>/gi;
  let m;
  while ((m = spanRe.exec(block)) !== null) {
    const t = cleanTag(m[1]);
    if (t) collected.push(t);
  }

  // 2) <a ...>TAG</a> (caso seus chips sejam links no futuro)
  const aRe = /<a\b[^>]*>([^<]{1,120})<\/a>/gi;
  while ((m = aRe.exec(block)) !== null) {
    const t = cleanTag(m[1]);
    if (t) collected.push(t);
  }

  // 3) listas markdown "- tag"
  const listRe = /^\s*[-*]\s+(.+?)\s*$/gm;
  while ((m = listRe.exec(block)) !== null) {
    const t = cleanTag(m[1]);
    if (t) collected.push(t);
  }

  // 4) fallback: se ainda não pegou nada, tenta por linhas "chipadas"
  if (collected.length === 0) {
    const lines = block
      .split("\n")
      .map((l) => cleanTag(l))
      .filter(Boolean);

    for (const line of lines) {
      // ignora o título
      if (line.toUpperCase() === "HEALTH CONDITION TAGS") continue;
      // ignora linhas muito longas (provável parágrafo)
      if (line.length > 80) continue;
      collected.push(line);
    }
  }

  // remove duplicados mantendo ordem
  const unique = [];
  const seen = new Set();
  for (const t of collected) {
    const key = t.toLowerCase();
    if (!t || seen.has(key)) continue;
    seen.add(key);
    unique.push(t);
    if (unique.length >= limit) break;
  }

  return unique;
};

/* =========================
   FILTER: ONLY FULL REVIEWS
========================= */
const categoryReviews = reviews
  .filter((review) => isSameCategory(review) && isFullReview(review))
  .sort((a, b) => {
    const ta = (a.data.pageTitle ?? a.data.title ?? "").toString();
    const tb = (b.data.pageTitle ?? b.data.title ?? "").toString();
    return ta.localeCompare(tb);
  });

/* =========================
   SEO META
========================= */
const categoryTitle = categoryConfig.title ?? categoryConfig.label ?? categoryKey;

const categoryDescription =
  categoryConfig.description ??
  `Explore in-depth supplement reviews for ${categoryTitle} on The Supplement Post.`;

const canonicalUrl = `${SITE_URL}/reviews/category/${slug}`;

const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "All Reviews", url: "/reviews" },
  { name: categoryTitle, url: `/reviews/category/${slug}` },
];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <!-- VIEWPORT PARA MOBILE -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{categoryTitle} — Supplement Reviews | The Supplement Post</title>
    <meta name="description" content={categoryDescription} />
    <meta name="robots" content="index,follow" />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Inter font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
    />

    <style>
      :root {
        --primary-blue: #1e3a8a;

        --bg-page: #f3f4f6;
        --bg-container: #ffffff;
        --bg-card: #ffffff;

        --text-main: #1f2937;
        --text-muted: #6b7280;

        --shadow-soft: 0 8px 24px rgba(0, 0, 0, 0.06);
        --border-subtle: #e5e7eb;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg-page);
        color: var(--text-main);
        font-family: "Inter", sans-serif;
      }

      /* HEADER */
      .site-header {
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      }

      .header-inner {
        max-width: 1120px;
        margin: 0 auto;
        padding: 14px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .brand {
        font-size: 14px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--primary-blue);
      }

      .header-nav {
        display: flex;
        gap: 14px;
      }

      .header-nav a {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-muted);
        text-decoration: none;
      }

      .header-nav a:hover {
        color: var(--primary-blue);
      }

      /* WRAPPER CENTRAL */
      .page-wrapper {
        max-width: 1120px;
        margin: 40px auto;
        background: var(--bg-container);
        padding: 40px 32px;
        border-radius: 22px;
        box-shadow: var(--shadow-soft);
      }

      /* Breadcrumb */
      .breadcrumb ol {
        padding: 0;
        margin: 0 0 18px;
        list-style: none;
        display: flex;
        gap: 6px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .breadcrumb a {
        text-decoration: none;
        color: var(--text-muted);
      }

      .breadcrumb-current {
        font-weight: 600;
        color: #374151;
      }

      /* Category Header */
      .category-hero {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid var(--border-subtle);
        padding: 28px 24px;
        margin-bottom: 40px;
      }

      .category-title {
        font-size: 32px;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0 0 10px;
      }

      .category-description {
        max-width: 680px;
        font-size: 15px;
        line-height: 1.6;
        color: var(--text-muted);
      }

      /* Article list */
      .article-list {
        display: flex;
        flex-direction: column;
        gap: 28px;
      }

      /* CARD */
      .article-card {
        display: block;
        background: var(--bg-card);
        border-radius: 18px;
        border: 1px solid var(--border-subtle);
        text-decoration: none;
        color: inherit;
        box-shadow: var(--shadow-soft);
        transition: 0.2s ease;
      }

      .article-card:hover {
        transform: translateY(-3px);
      }

      .article-card-inner {
        display: flex;
        flex-direction: column;
      }

      @media (min-width: 768px) {
        .article-card-inner {
          flex-direction: row;
          height: 240px;
        }
      }

      .article-image-container {
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 180px;
      }

      @media (min-width: 768px) {
        .article-image-container {
          width: 34%;
          height: 100%;
        }
      }

      .article-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 20px;
      }

      .article-content {
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      @media (min-width: 768px) {
        .article-content {
          width: 66%;
          padding: 32px;
        }
      }

      .article-title {
        font-size: 22px;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0 0 12px;
      }

      .article-description {
        margin: 0 0 8px;
        font-size: 15px;
        line-height: 1.6;
        color: #374151;
      }

      /* ✅ Health Condition Tags */
      .health-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 6px 0 10px;
      }

      .health-tag {
        font-size: 11px;
        padding: 6px 10px;
        background: #f1f5f9;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        color: #374151;
        white-space: nowrap;
      }

      .article-cta {
        margin-top: auto;
        font-size: 14px;
        font-weight: 600;
        color: var(--primary-blue);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      /* Footer */
      .site-footer {
        margin-top: 60px;
        background: #ffffff;
        border-top: 1px solid #e5e7eb;
      }

      .footer-inner {
        max-width: 1120px;
        margin: 0 auto;
        padding: 18px;
        text-align: center;
        font-size: 12px;
        color: #6b7280;
      }

      @media (max-width: 640px) {
        .header-inner {
          padding: 12px 12px;
        }

        .brand {
          font-size: 12px;
          letter-spacing: 0.18em;
        }

        .page-wrapper {
          margin: 24px 12px;
          padding: 24px 18px;
          border-radius: 18px;
        }

        .breadcrumb ol {
          font-size: 11px;
          flex-wrap: wrap;
        }

        .category-hero {
          padding: 22px 18px;
          margin-bottom: 28px;
        }

        .category-title {
          font-size: 24px;
          line-height: 1.25;
        }

        .category-description {
          font-size: 14px;
        }

        .article-image-container {
          height: 200px;
        }

        .article-content {
          padding: 20px;
        }

        .article-title {
          font-size: 18px;
        }

        .article-description {
          font-size: 14px;
        }

        .article-cta {
          font-size: 14px;
        }

        .footer-inner {
          font-size: 11px;
          padding: 16px;
        }
      }
    </style>
  </head>

  <body>
    <header class="site-header">
      <div class="header-inner">
        <div class="brand">The Supplement Post</div>
        <nav class="header-nav">
          <a href="/">Home</a>
          <a href="/reviews">Reviews</a>
        </nav>
      </div>
    </header>

    <main class="page-wrapper">
      <nav class="breadcrumb">
        <ol>
          {breadcrumbs.map((crumb, index) => (
            <li>
              {index > 0 && <span>/</span>}
              {index < breadcrumbs.length - 1 ? (
                <a href={crumb.url}>{crumb.name}</a>
              ) : (
                <span class="breadcrumb-current">{crumb.name}</span>
              )}
            </li>
          ))}
        </ol>
      </nav>

      <section class="category-hero">
        <h1 class="category-title">{categoryTitle}</h1>
        <p class="category-description">{categoryDescription}</p>
      </section>

      {categoryReviews.length === 0 ? (
        <p>No reviews found for this category.</p>
      ) : (
        <section class="article-list">
          {categoryReviews.map((review) => {
            const title = review.data.pageTitle ?? review.data.title;
            const description = review.data.description ?? "";
            const heroImage = review.data.heroImage;

            // ✅ Extrai automaticamente do body do review
            const healthTags = extractHealthTagsFromBody(review.body, 8);

            // ✅ Link SEMPRE no formato público: /reviews/{slug-limpo}
            const href = `/reviews/${getPublicSlug(review)}`;

            return (
              <a href={href} class="article-card">
                <div class="article-card-inner">
                  <div class="article-image-container">
                    {heroImage ? (
                      <img src={heroImage} alt={title} class="article-image" />
                    ) : null}
                  </div>

                  <div class="article-content">
                    <h2 class="article-title">{title}</h2>
                    <p class="article-description">{description}</p>

                    {healthTags.length > 0 ? (
                      <div class="health-tags">
                        {healthTags.map((tag) => (
                          <span class="health-tag">{tag}</span>
                        ))}
                      </div>
                    ) : null}

                    <div class="article-cta">Read Full Review →</div>
                  </div>
                </div>
              </a>
            );
          })}
        </section>
      )}
    </main>

    <footer class="site-footer">
      <div class="footer-inner">© The Supplement Post. All rights reserved.</div>
    </footer>
  </body>
</html>
