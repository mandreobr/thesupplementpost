---
import { getCollection } from "astro:content";
import { CATEGORY_CONFIG } from "../../../config/categories";
import { SITE_URL } from "../../../config/site";

/* =========================
   STATIC PATHS
========================= */
export async function getStaticPaths() {
  return Object.values(CATEGORY_CONFIG).map((config) => ({
    params: { slug: config.slug },
  }));
}

/* =========================
   LOAD CONTENT
========================= */
const reviews = await getCollection("reviews");
const { slug } = Astro.params;

if (!slug) {
  throw new Error("Category slug is missing.");
}

/* =========================
   MATCH CATEGORY CONFIG
========================= */
const entry = Object.entries(CATEGORY_CONFIG).find(([, cfg]) => cfg.slug === slug);

if (!entry) {
  throw new Error(`Category not found for slug: ${slug}`);
}

const [categoryKey, categoryConfig] = entry;

/* =========================
   HELPERS
========================= */
const normalize = (value) =>
  value
    ? String(value)
        .trim()
        .toLowerCase()
        .replace(/[‚Äô']/g, "")
        .replace(/\s+/g, "-")
    : "";

const splitParts = (val) =>
  String(val || "").replace(/\\/g, "/").split("/").filter(Boolean);

const getFolderCategorySlugFromId = (id) => {
  const first = splitParts(id)[0];
  return normalize(first);
};

// ‚úÖ lista can√¥nica de minis (inclui "official" pois voc√™ tem official.md)
const MINI_KEYS = [
  "what-is",
  "ingredients",
  "side-effects",
  "price",
  "pros-and-cons",
  "does-really-work",
  "official",
];

// ‚úÖ Detecta minis por NOME DO ARQUIVO: price.md, ingredients.md etc
const looksLikeMini = (id) => {
  const parts = splitParts(id);
  if (!parts.length) return false;

  const last = parts[parts.length - 1]; // ex: "price.md" | "index.md"
  const file = String(last).replace(/\.md$/, ""); // "price" | "index"

  return MINI_KEYS.includes(file);
};

/**
 * ‚úÖ FULL REVIEW
 * Regra real do seu projeto: full review = .../index.md
 * (sem depender de layout)
 */
const isFullReview = (review) => {
  const id = String(review?.id || "").replace(/\\/g, "/");

  if (!id.endsWith("/index.md")) return false;
  if (looksLikeMini(id)) return false;

  return true;
};

const isSameCategory = (review) => {
  // 1) frontmatter category (se existir)
  const byFrontmatter = review?.data?.category === slug;

  // 2) fallback: pasta (men-health)
  const byFolder = getFolderCategorySlugFromId(review?.id) === slug;

  return byFrontmatter || byFolder;
};

/**
 * ‚úÖ Slug p√∫blico do produto:
 * - usa o 2¬∫ segmento do id: category/product/...
 */
const getPublicSlug = (review) => {
  const parts = splitParts(review?.id); // ["men-health","prostadine","index.md"]
  return parts[1] || "";
};

const decodeHtmlEntities = (str) =>
  String(str || "")
    .replace(/&amp;/g, "&")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .trim();

const cleanTag = (tag) => {
  let t = decodeHtmlEntities(tag);
  t = t.replace(/\s+/g, " ").trim();
  t = t.replace(/[‚Ä¢¬∑|]+$/g, "").trim();
  return t;
};

/**
 * ‚úÖ Extrai Health Condition Tags do bloco "HEALTH CONDITION TAGS"
 * Regra: pega tudo entre "HEALTH CONDITION TAGS" e "INGREDIENT TAGS" (ou fim)
 */
const extractHealthTagsFromBody = (body, limit = 8) => {
  const raw = String(body || "");
  const startIdx = raw.toUpperCase().indexOf("HEALTH CONDITION TAGS");
  if (startIdx === -1) return [];

  const afterStart = raw.slice(startIdx);
  const endIdxLocal = afterStart.toUpperCase().indexOf("INGREDIENT TAGS");
  const block = endIdxLocal !== -1 ? afterStart.slice(0, endIdxLocal) : afterStart;

  const collected = [];

  // 1) <span>TAG</span>
  const spanRe = /<span\b[^>]*>([^<]{1,120})<\/span>/gi;
  let m;
  while ((m = spanRe.exec(block)) !== null) {
    const t = cleanTag(m[1]);
    if (t) collected.push(t);
  }

  // 2) <a>TAG</a>
  const aRe = /<a\b[^>]*>([^<]{1,120})<\/a>/gi;
  while ((m = aRe.exec(block)) !== null) {
    const t = cleanTag(m[1]);
    if (t) collected.push(t);
  }

  // 3) lista markdown "- tag"
  const listRe = /^\s*[-*]\s+(.+?)\s*$/gm;
  while ((m = listRe.exec(block)) !== null) {
    const t = cleanTag(m[1]);
    if (t) collected.push(t);
  }

  // 4) fallback por linhas
  if (collected.length === 0) {
    const lines = block
      .split("\n")
      .map((l) => cleanTag(l))
      .filter(Boolean);

    for (const line of lines) {
      if (line.toUpperCase() === "HEALTH CONDITION TAGS") continue;
      if (line.length > 80) continue;
      collected.push(line);
    }
  }

  // dedupe mantendo ordem
  const unique = [];
  const seen = new Set();
  for (const t of collected) {
    const key = t.toLowerCase();
    if (!t || seen.has(key)) continue;
    seen.add(key);
    unique.push(t);
    if (unique.length >= limit) break;
  }

  return unique;
};

/* =========================
   FILTER: ONLY FULL REVIEWS
========================= */
const categoryReviews = reviews
  .filter((review) => isSameCategory(review) && isFullReview(review))
  .sort((a, b) => {
    const ta = (a.data.pageTitle ?? a.data.title ?? "").toString();
    const tb = (b.data.pageTitle ?? b.data.title ?? "").toString();
    return ta.localeCompare(tb);
  });

/* =========================
   SEO META
========================= */
const categoryTitle = categoryConfig.title ?? categoryConfig.label ?? categoryKey;

const categoryDescription =
  categoryConfig.description ??
  `Explore in-depth supplement reviews for ${categoryTitle} on The Supplement Post.`;

const canonicalUrl = `${SITE_URL}/reviews/category/${slug}`;

const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "All Reviews", url: "/reviews" },
  { name: categoryTitle, url: `/reviews/category/${slug}` },
];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{categoryTitle} ‚Äî Supplement Reviews | The Supplement Post</title>
    <meta name="description" content={categoryDescription} />
    <meta name="robots" content="index,follow" />
    <link rel="canonical" href={canonicalUrl} />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
    />

    <style>
      :root {
        --primary-blue: #1e3a8a;

        --bg-page: #f3f4f6;
        --bg-container: #ffffff;
        --bg-card: #ffffff;

        --text-main: #1f2937;
        --text-muted: #6b7280;

        --shadow-soft: 0 8px 24px rgba(0, 0, 0, 0.06);
        --border-subtle: #e5e7eb;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg-page);
        color: var(--text-main);
        font-family: "Inter", sans-serif;
      }

      .site-header {
        background: #ffffff;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      }

      .header-inner {
        max-width: 1120px;
        margin: 0 auto;
        padding: 14px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .brand {
        font-size: 14px;
        letter-spacing: 0.25em;
        text-transform: uppercase;
        font-weight: 700;
        color: var(--primary-blue);
      }

      .header-nav {
        display: flex;
        gap: 14px;
      }

      .header-nav a {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-muted);
        text-decoration: none;
      }

      .header-nav a:hover {
        color: var(--primary-blue);
      }

      .page-wrapper {
        max-width: 1120px;
        margin: 40px auto;
        background: var(--bg-container);
        padding: 40px 32px;
        border-radius: 22px;
        box-shadow: var(--shadow-soft);
      }

      .breadcrumb ol {
        padding: 0;
        margin: 0 0 18px;
        list-style: none;
        display: flex;
        gap: 6px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .breadcrumb a {
        text-decoration: none;
        color: var(--text-muted);
      }

      .breadcrumb-current {
        font-weight: 600;
        color: #374151;
      }

      .category-hero {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid var(--border-subtle);
        padding: 28px 24px;
        margin-bottom: 40px;
      }

      .category-title {
        font-size: 32px;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0 0 10px;
      }

      .category-description {
        max-width: 680px;
        font-size: 15px;
        line-height: 1.6;
        color: var(--text-muted);
      }

      .article-list {
        display: flex;
        flex-direction: column;
        gap: 28px;
      }

      .article-card {
        display: block;
        background: var(--bg-card);
        border-radius: 18px;
        border: 1px solid var(--border-subtle);
        text-decoration: none;
        color: inherit;
        box-shadow: var(--shadow-soft);
        transition: 0.2s ease;
      }

      .article-card:hover {
        transform: translateY(-3px);
      }

      .article-card-inner {
        display: flex;
        flex-direction: column;
      }

      @media (min-width: 768px) {
        .article-card-inner {
          flex-direction: row;
          height: 240px;
        }
      }

      .article-image-container {
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 180px;
      }

      @media (min-width: 768px) {
        .article-image-container {
          width: 34%;
          height: 100%;
        }
      }

      .article-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        padding: 20px;
      }

      .article-content {
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      @media (min-width: 768px) {
        .article-content {
          width: 66%;
          padding: 32px;
        }
      }

      .article-title {
        font-size: 22px;
        font-weight: 800;
        color: var(--primary-blue);
        margin: 0 0 12px;
      }

      .article-description {
        margin: 0 0 8px;
        font-size: 15px;
        line-height: 1.6;
        color: #374151;
      }

      .health-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 6px 0 10px;
      }

      .health-tag {
        font-size: 11px;
        padding: 6px 10px;
        background: #f1f5f9;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        color: #374151;
        white-space: nowrap;
      }

      .article-cta {
        margin-top: auto;
        font-size: 14px;
        font-weight: 600;
        color: var(--primary-blue);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      /* =========================
         PAGINATION (CLIENT-SIDE)
      ========================= */
      .pagination {
        margin-top: 28px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .page-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        background: #ffffff;
        color: var(--primary-blue);
        text-decoration: none;
        font-weight: 700;
        font-size: 13px;
      }

      .page-btn[aria-disabled="true"] {
        opacity: 0.45;
        pointer-events: none;
      }

      .page-indicator {
        font-size: 13px;
        color: #374151;
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <header class="site-header">
      <div class="header-inner">
        <div class="brand">The Supplement Post</div>
        <nav class="header-nav">
          <a href="/">Home</a>
          <a href="/reviews">Reviews</a>
        </nav>
      </div>
    </header>

    <main class="page-wrapper">
      <nav class="breadcrumb">
        <ol>
          {breadcrumbs.map((crumb, index) => (
            <li>
              {index > 0 && <span>/</span>}
              {index < breadcrumbs.length - 1 ? (
                <a href={crumb.url}>{crumb.name}</a>
              ) : (
                <span class="breadcrumb-current">{crumb.name}</span>
              )}
            </li>
          ))}
        </ol>
      </nav>

      <section class="category-hero">
        <h1 class="category-title">{categoryTitle}</h1>
        <p class="category-description">{categoryDescription}</p>
      </section>

      {categoryReviews.length === 0 ? (
        <p>No reviews found for this category.</p>
      ) : (
        <>
          <section class="article-list" id="reviewsList">
            {categoryReviews.map((review) => {
              const title = review.data.pageTitle ?? review.data.title;
              const description = review.data.description ?? "";
              const heroImage = review.data.heroImage;

              const healthTags = extractHealthTagsFromBody(review.body, 8);
              const href = `/reviews/${getPublicSlug(review)}`;

              return (
                <a href={href} class="article-card" data-review-card>
                  <div class="article-card-inner">
                    <div class="article-image-container">
                      {heroImage ? <img src={heroImage} alt={title} class="article-image" /> : null}
                    </div>

                    <div class="article-content">
                      <h2 class="article-title">{title}</h2>
                      <p class="article-description">{description}</p>

                      {healthTags.length > 0 ? (
                        <div class="health-tags">
                          {healthTags.map((tag) => (
                            <span class="health-tag">{tag}</span>
                          ))}
                        </div>
                      ) : null}

                      <div class="article-cta">Read Full Review ‚Üí</div>
                    </div>
                  </div>
                </a>
              );
            })}
          </section>

          <nav class="pagination" aria-label="Pagination">
            <a class="page-btn" href="#" id="prevBtn" aria-disabled="true">‚Üê Prev</a>
            <div class="page-indicator" id="pageIndicator">Page 1</div>
            <a class="page-btn" href="#" id="nextBtn" aria-disabled="true">Next ‚Üí</a>
          </nav>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const PER_PAGE = 10;

    const list = document.getElementById("reviewsList");
    const nav = document.querySelector(".pagination");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const indicator = document.getElementById("pageIndicator");

    if (!list || !prevBtn || !nextBtn || !indicator) return;

    const cards = Array.from(list.querySelectorAll(".article-card"));
    const total = cards.length;
    const totalPages = Math.max(1, Math.ceil(total / PER_PAGE));

    // üîí esconde tudo primeiro (garantia)
    cards.forEach((el) => (el.style.display = "none"));

    const getPageFromHash = () => {
      const match = window.location.hash.match(/page=(\d+)/i);
      const page = match ? parseInt(match[1], 10) : 1;
      if (!Number.isFinite(page) || page < 1) return 1;
      return Math.min(page, totalPages);
    };

    const setHashPage = (page) => {
      window.location.hash = `page=${page}`;
    };

    const render = (page) => {
      const start = (page - 1) * PER_PAGE;
      const end = start + PER_PAGE;

      cards.forEach((el, idx) => {
        el.style.display = idx >= start && idx < end ? "block" : "none";
      });

      indicator.textContent = `Page ${page} of ${totalPages}`;

      prevBtn.setAttribute("aria-disabled", page <= 1 ? "true" : "false");
      nextBtn.setAttribute("aria-disabled", page >= totalPages ? "true" : "false");
    };

    prevBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const page = getPageFromHash();
      if (page > 1) {
        setHashPage(page - 1);
        render(page - 1);
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });

    nextBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const page = getPageFromHash();
      if (page < totalPages) {
        setHashPage(page + 1);
        render(page + 1);
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });

    window.addEventListener("hashchange", () => {
      render(getPageFromHash());
    });

    // init
    render(getPageFromHash());

    if (totalPages <= 1 && nav) {
      nav.style.display = "none";
    }
  });
</script>


        </>
      )}
    </main>

    <footer class="site-footer">
      <div class="footer-inner">¬© The Supplement Post. All rights reserved.</div>
    </footer>
  </body>
</html>
