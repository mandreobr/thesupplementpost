---
import { getCollection } from "astro:content";
import { CATEGORY_CONFIG } from "../../../config/categories";

// 1) Gerar todos os caminhos estáticos para as categorias
export async function getStaticPaths() {
  const paths = Object.values(CATEGORY_CONFIG).map((config) => ({
    params: { slug: config.slug },
  }));

  return paths;
}

// 2) Carregar todos os reviews
const reviews = await getCollection("reviews");

// 3) Ler o slug da URL e encontrar a categoria correspondente
const { slug } = Astro.params;

const entries = Object.entries(CATEGORY_CONFIG);
const match = entries.find(([, cfg]) => cfg.slug === slug);

if (!match) {
  throw new Error(`Category not found for slug: ${slug}`);
}

const [categoryKey, categoryConfig] = match;

// 4) Filtrar reviews dessa categoria (usa a chave da CATEGORY_CONFIG)
const categoryReviews = reviews.filter(
  (review) => review.data.category === categoryKey
);

// Helpers para título/descrição
const categoryTitle =
  categoryConfig.title ?? categoryConfig.label ?? categoryKey;
const categoryDescription =
  categoryConfig.description ??
  `Explore supplement reviews for ${categoryTitle} on Best Supplements Today.`;

const canonicalUrl = `https://www.bestsupplementstoday.com/reviews/category/${slug}/`;
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>
      {categoryTitle} — Supplement Reviews | Best Supplements Today
    </title>
    <meta name="description" content={categoryDescription} />
    <meta
      name="robots"
      content={categoryReviews.length === 0
        ? "noindex,follow"
        : "index,follow"}
    />
    <link rel="canonical" href={canonicalUrl} />
  </head>

  <body class="bg-white text-slate-900">
    <main class="min-h-screen max-w-6xl mx-auto px-4 pb-16">
      <header class="pt-10 pb-8 text-center flex flex-col items-center gap-3">
        <a
          href="/reviews"
          class="text-xs uppercase tracking-wide text-slate-500 hover:text-slate-800"
        >
          ← Back to All Reviews
        </a>

        <h1 class="text-3xl md:text-4xl font-extrabold">
          {categoryTitle}
        </h1>

        <p class="text-base md:text-lg text-slate-600 max-w-3xl">
          {categoryDescription}
        </p>
      </header>

      {categoryReviews.length === 0 ? (
        <section class="mt-10 text-center text-slate-600">
          <p>
            No reviews have been published for this category yet. Check back
            soon.
          </p>
        </section>
      ) : (
        <section class="mt-6">
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {categoryReviews.map((review) => (
              <article class="border border-slate-200 rounded-2xl p-5 shadow-sm bg-white flex flex-col justify-between">
                <div>
                  <h2 class="text-lg font-semibold mb-2">
                    <a
                      href={`/reviews/${review.slug}`}
                      class="hover:text-blue-700 transition-colors"
                    >
                      {review.data.pageTitle ?? review.data.title}
                    </a>
                  </h2>

                  {review.data.metaDescription && (
                    <p class="text-sm text-slate-600">
                      {review.data.metaDescription}
                    </p>
                  )}
                </div>

                <div class="mt-4">
                  <a
                    href={`/reviews/${review.slug}`}
                    class="inline-flex items-center text-sm font-semibold text-blue-700 hover:text-blue-900"
                  >
                    Read full review
                    <span class="ml-1">→</span>
                  </a>
                </div>
              </article>
            ))}
          </div>
        </section>
      )}
    </main>
  </body>
</html>
