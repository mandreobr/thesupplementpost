---
import { getCollection } from "astro:content";
import { CATEGORY_CONFIG } from "../../../config/categories";

// 1) Gerar todos os caminhos estáticos para as categorias
export async function getStaticPaths() {
  const paths = Object.values(CATEGORY_CONFIG).map((config) => ({
    params: { slug: config.slug },
  }));

  return paths;
}

// 2) Carregar todos os reviews
const reviews = await getCollection("reviews");

// 3) Ler o slug da URL e encontrar a categoria correspondente
const { slug } = Astro.params;

const entries = Object.entries(CATEGORY_CONFIG);
const match = entries.find(([, cfg]) => cfg.slug === slug);

if (!match) {
  throw new Error(`Category not found for slug: ${slug}`);
}

const [categoryKey, categoryConfig] = match;

// 4) Filtrar reviews dessa categoria (usa a chave da CATEGORY_CONFIG)
const categoryReviews = reviews.filter(
  (review) => review.data.category === categoryKey
);

// Helpers de texto
const categoryTitle =
  categoryConfig.title ?? categoryConfig.label ?? categoryKey;
const categoryDescription =
  categoryConfig.description ??
  `Explore supplement reviews related to ${categoryTitle} on Best Supplements Today.`;

const canonicalUrl = `https://www.bestsupplementstoday.com/reviews/category/${slug}/`;

// Breadcrumb simples para SEO + UX
const breadcrumbs = [
  { name: "Home", url: "/" },
  { name: "All Reviews", url: "/reviews" },
  { name: categoryTitle, url: canonicalUrl },
];
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>
      {categoryTitle} — Supplement Reviews | Best Supplements Today
    </title>

    <meta name="description" content={categoryDescription} />
    <meta
      name="robots"
      content={categoryReviews.length === 0
        ? "noindex,follow"
        : "index,follow"}
    />
    <link rel="canonical" href={canonicalUrl} />
  </head>

  <body class="bg-white text-slate-900">
    <main class="min-h-screen max-w-6xl mx-auto px-4 pb-16">
      {/* Breadcrumb */}
      <nav class="pt-6 text-xs text-slate-500">
        <ol class="flex flex-wrap items-center gap-1">
          {breadcrumbs.map((crumb, index) => (
            <li class="flex items-center">
              {index > 0 && <span class="mx-1 text-slate-400">/</span>}
              {index < breadcrumbs.length - 1 ? (
                <a href={crumb.url} class="hover:text-slate-800">
                  {crumb.name}
                </a>
              ) : (
                <span class="text-slate-700 font-semibold">
                  {crumb.name}
                </span>
              )}
            </li>
          ))}
        </ol>
      </nav>

      {/* Hero da categoria */}
      <header class="pt-6 pb-8 flex flex-col items-center text-center gap-4">
        <div class="inline-flex items-center justify-center rounded-full border border-slate-200 px-3 py-1 text-xs font-medium text-slate-600 bg-slate-50">
          Category
        </div>

        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
          {categoryTitle}
        </h1>

        <p class="text-base md:text-lg text-slate-600 max-w-3xl">
          {categoryDescription}
        </p>

        <p class="text-xs uppercase tracking-wide text-slate-500">
          {categoryReviews.length === 0
            ? "No reviews published yet"
            : `${categoryReviews.length} review${categoryReviews.length > 1 ? "s" : ""} in this category`}
        </p>
      </header>

      {/* Conteúdo da categoria: grid de reviews */}
      {categoryReviews.length === 0 ? (
        <section class="mt-10 text-center text-slate-600">
          <p class="mb-4">
            We haven’t published reviews in this category yet. New articles will
            be added soon.
          </p>
          <a
            href="/reviews"
            class="inline-flex items-center text-sm font-semibold text-blue-700 hover:text-blue-900"
          >
            ← Browse all reviews
          </a>
        </section>
      ) : (
        <section class="mt-4">
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {categoryReviews.map((review) => {
              const title = review.data.pageTitle ?? review.data.title;
              const description = review.data.metaDescription ?? "";
              const heroImage =
                review.data.heroImage ||
                review.data.imageHero ||
                review.data.image ||
                null;

              return (
                <article class="border border-slate-200 rounded-2xl overflow-hidden bg-white flex flex-col h-full shadow-sm hover:shadow-md transition-shadow">
                  {/* Imagem opcional do review (se existir no frontmatter) */}
                  {heroImage && (
                    <a href={`/reviews/${review.slug}`}>
                      <img
                        src={heroImage}
                        alt={title}
                        loading="lazy"
                        class="w-full h-40 object-cover"
                      />
                    </a>
                  )}

                  <div class="p-5 flex flex-col flex-1">
                    <h2 class="text-lg font-semibold mb-2">
                      <a
                        href={`/reviews/${review.slug}`}
                        class="hover:text-blue-700 transition-colors"
                      >
                        {title}
                      </a>
                    </h2>

                    {description && (
                      <p class="text-sm text-slate-600 mb-4 line-clamp-3">
                        {description}
                      </p>
                    )}

                    <div class="mt-auto pt-2">
                      <a
                        href={`/reviews/${review.slug}`}
                        class="inline-flex items-center text-sm font-semibold text-blue-700 hover:text-blue-900"
                      >
                        Read full review
                        <span class="ml-1">→</span>
                      </a>
                    </div>
                  </div>
                </article>
              );
            })}
          </div>
        </section>
      )}
    </main>
  </body>
</html>
